cursor-plan://60ecb8b9-317d-4f55-9259-1f7f8278559d/restore.plan.md {"content":"<!-- 60ecb8b9-317d-4f55-9259-1f7f8278559d ccf34b4f-9be4-44d3-a433-e4ebdfbe9237 -->\n# Minimal Fix: Prevent Shot Swap on First Change\n\n## Objective\n\nEliminate the shot swapping that occurs on the first layout change after project load, with minimal, low‑risk edits.\n\n## Root Cause Addressed\n\n`page.shots` and `shotOrder` can be out of sync on load. The first action triggers redistribution that snaps `page.shots` to `shotOrder`, causing visible swaps.\n\n## Changes\n\n1) Add reconciliation helper (unified store `src/store/index.ts`)\n\n- `reconcileShotsAndPagesOnLoad()`:\n- Build `visibleOrder = pages.flatMap(p => p.shots)`.\n- If sets match and order differs from `shotOrder`, set `shotOrder = visibleOrder` and renumber once.\n- No page rewrites here; preserves the layout users see.\n\n2) Call reconciliation once on app load\n\n- `src/pages/Index.tsx`: `useEffect` after stores hydrate to call `reconcileShotsAndPagesOnLoad()`.\n- Optionally call again on project switch if applicable.\n\n3) Guard redistribution (no behavioral change)\n\n- Keep `redistributeShotsAcrossPages()` as-is; the reconciliation ensures it won’t cause swaps on first change.\n\n## Out of Scope (deferred)\n\n- Insert/Overwrite UI toggles, batch transaction helpers, post-batch reconciliation, sub-shot boundary clamp. These can follow after the bug is fixed.\n\n## Validation\n\n- Load a project with known S1–S5 order; perform first change → no swaps.\n- Multi-page projects: verify per-page order remains intact after first change.\n- Renumbering still reflects correct formatted numbers.\n\n### To-dos\n\n- [ ] Restore Insert/Overwrite toggle in BatchLoadModal UI and state\n- [ ] Implement insert/overwrite logic in BatchLoadModal with single end redistribution\n- [ ] Restore Insert/Overwrite toggle in ShotListLoadModal UI and state\n- [ ] Implement insert/overwrite logic in ShotListLoadModal with single end redistribution\n- [ ] Add begin/end layout transaction helpers to defer renumber/redistribute\n- [ ] Add reconcilePageShotsWithShotOrder() in useAppStore\n- [ ] Call reconcile once in Index.tsx post-hydration\n- [ ] Call reconcile at end of both import flows\n- [ ] Clamp custom insert to sub-shot group boundaries (optional)","typeId":"markdownPlan"}
